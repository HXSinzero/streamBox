<title>任务管理</title>

<div class="layui-fluid">

    <div class="layui-card">

        <div class="layui-tab" lay-filter="filter-tab-task">
            <ul class="layui-tab-title">
                <li class="layui-this" lay-id="1">任务</li>               
                <li lay-id="2">任务取消处理</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">

                    <form class="layui-form" action="">
                        <div class="layui-form-item">

                            <!--时间范围-->
                            <div class="layui-inline" style="width:400px;">
                                <label class="layui-form-label">时间范围：</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="datetimerange" class="layui-input" id="task-laydate-datetimerange1"  autocomplete="off" style="width:300px;">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">任务类别</label>
                                <div class="layui-input-block">
                                    <select name="TASKTCLASS">
                                        <option value="0">不限</option>
                                        <option value="1">入库任务</option>
                                        <option value="2">出库任务</option>
                                        <option value="3">移动任务</option>
                                    </select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">任务状态</label>
                                <div class="layui-input-block">
                                    <select name="TASKSTATE">
                                        <option value="">不限</option>
                                        <option value="0">新任务</option>
                                        <option value="99">任务结束</option>
                                        <option value="4">任务取消</option>
                                        <option value="notover">未完成的任务</option>
                                    </select>
                                </div>
                            </div>

                        </div>

                        <div class="layui-form-item">

                            <div class="layui-inline">
                                <label class="layui-form-label">任务ID:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="ID" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">任务号:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="TASKNO" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">托盘ID:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="PALLETID" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">托盘编号:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="PALLETNO" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">关联单号:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="RelateNo" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">起始站台:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="SourceNo" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label">目标站台:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="DescNo" placeholder="请输入……" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-inline" style="display:none;">
                                <label class="layui-form-label">查历史记录？</label>
                                <div class="layui-inline">
                                    <input type="checkbox" id="task-IsHistory" value="0" name="IsHistory" lay-skin="switch"
                                           lay-filter="taskIsHistorySwitch"
                                           {{ d.IsHistory == '1' ? 'checked' : '' }}>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label"></label>
                                <button class="layui-btn" lay-submit lay-filter="tasksearchfilter">
                                    <i class="layui-icon layui-icon-search"></i>
                                </button>
                            </div>


                        </div>
                    </form>

                    <!--任务主表-->
                    <table id="id-tablelist-task" lay-filter="filter-tasktablelist"></table>

                    <div class="layui-card" style="display:none;">
                        <!--任务子表-->
                        <table id="id-tablelist-taskstep" lay-filter="filter-tasksteptablelist"></table>
                    </div>
                </div>
               
                <!--任务取消-->
                <div class="layui-tab-item">
                    <form class="layui-form">
                        <div class="layui-form-item">

                            <!--任务ID-->
                            <div class="layui-inline">
                                <label class="layui-form-label">任务ID:</label>
                                <div class="layui-input-block">
                                    <input type="text" id="idTASKID" name="ID" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <!--任务号-->
                            <div class="layui-inline">
                                <label class="layui-form-label">任务号:</label>
                                <div class="layui-input-block">
                                    <input type="text" id="idTASKNO" name="TASKNO" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>


                            <!--起始地址-->
                            <div class="layui-inline">
                                <label class="layui-form-label">起始地址:</label>
                                <div class="layui-input-block">
                                    <input type="text" id="idSOURCE01" name="SOURCE01" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <!--目标地址-->
                            <div class="layui-inline">
                                <label class="layui-form-label">目标地址:</label>
                                <div class="layui-input-block">
                                    <input type="text" id="idDESTINATION01" name="DESTINATION01" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                        </div>

                        <div class="layui-form-item">
                            <!--任务描述-->
                            <div class="layui-inline" style="width:600px;">
                                <label class="layui-form-label">任务描述:</label>
                                <div class="layui-input-block">
                                    <input type="text" id="idTASKDESC" name="TASKDESC" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                            <!--取消操作码-->
                            <div class="layui-inline">
                                <label class="layui-form-label">操作码：</label>
                                <div class="layui-input-block">
                                    <select name="CANCELCODE" lay-verify="required">
                                        <option value="">请选择</option>
                                        <option value="OP01">入库任务取消(OP01)</option>
                                        <option value="OP02">出库任务取消(OP02)</option>
                                        <option value="OP04">仅修改任务状态(OP04)</option>
                                    </select>
                                </div>
                            </div>

                            <!--取消原因描述-->
                            <div class="layui-inline" style="width:600px;">
                                <label class="layui-form-label">取消原因:</label>
                                <div class="layui-input-block">
                                    <input type="text" name="CANCELREASON" placeholder="请输入……" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>
                            </div>

                        </div>

                        <div class="layui-form-item">

                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label"></label>
                            <div class="input-block">
                                <button class="layui-btn layui-btn-danger" lay-submit lay-filter="task-CancelOpration">
                                    确认执行任务取消
                                </button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>

                        </div>
                    </form>

                    <div class="layui-card">
                        <h1>操作码说明：</h1>
                        <h2><span style="color:red;font-size:18px;">OP01:入库任务取消：</span>删除起始位置的托盘，释放目标位置的分配锁定，取消入库单据；多用于入库时，多申请的任务或已申请入库但设备故障后无法执行的任务处理；<span style="color:blue;">【任务状态改为4，托盘及明细删除，货位状态改为0，单据状态改为4】</span></h2>
                        <h2><span style="color:red;font-size:18px;">OP02:出库任务取消：</span>还原库存到起始位置，释放对目标位置的分配锁定，取消出库单据；多用于出库时，由于设备故障任务未执行，托盘还原到货位的任务处理；<span style="color:blue;">【任务状态改为4，托盘状态改为3，货位状态改为100，单据状态改为4】</span></h2>
                        <h2><span style="color:red;font-size:18px;">OP04:仅修改任务状态：</span>只修改任务状态，其他联系系统管理人员处理；<span style="color:blue;">【任务状态改为4】</span></h2>
                    </div>

                    <div class="layui-card">
                        <h1>任务状态：	0=新任务	99=搬运完成	4=任务取消</h1>
                        <h1>存储状态：0=空闲	100=载货</h1>
                        <h1>托盘状态：1=新创建 2=搬运锁定 3=搬运完成</h1>
                        <h1>计划状态：4=取消  5=完成 </h1>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script>
    layui.use(['admin', 'table', 'laydate', 'layer', 'element'], function () {
        var $ = layui.$,
            setter = layui.setter,
            admin = layui.admin,
            table = layui.table,
            form = layui.form,
            laydate = layui.laydate,
            layer = layui.layer,
            element = layui.element;

        form.render();

        var myDate = new Date();

        //日期时间范围
        laydate.render({
            elem: '#task-laydate-datetimerange1'
            , type: 'datetime'
            , range: true
            , min: -7
            , max: 1
        });

        //任务数据列表
        table.render({
            elem: '#id-tablelist-task',
            url: setter.gettasklist + "?ACTION=100",
            //data:[],
            cols: [[
                { field: 'ID', title: 'ID', false: true, width: 100 }

                , { field: 'TASKNO', title: '任务号', hide: false, width: 100 }
                , { field: 'TASKTCLASS', title: '任务分类', hide: false, width: 100, templet: '#taskclassTpl' }
                , { field: 'TASKTYPE', title: '任务类型', hide: false, width: 100 }
                , { field: 'TASKSTATE', title: '任务状态', hide: false, width: 100, templet: '#taskstateTpl' }

                , { field: 'CANCELREASON', title: '取消原因', hide: false, width: 150, style: 'color: red;font-size:24px;' }

                , { field: 'CREATEDATE', title: '创建时间', hide: false, width: 180, sort: true}

                , { field: 'PRIORITY', title: '优先级', hide: false, width: 100 }
                , { field: 'PALLETID', title: '托盘ID', hide: false, width: 100 }
                , { field: 'PALLETNO', title: '托盘号', hide: false, width: 100 }
                , { field: 'SOURCE02', title: '源控制号', hide: false, width: 150, sort: true, style: 'background-color: #007688; color: #fff;' }
                , { field: 'DESTINATION02', title: '目标控制号', hide: false, width: 150, sort: true, style: 'background-color: #000088; color: #fff;' }
                , { field: 'TASKGROUPNO', title: '任务组号', hide: true, width: 100 }
                , { field: 'TASKDESC', title: '任务描述', hide: false, width: 350, style: 'background-color: green; color: #fff;' }
                , { field: 'PRETASKNO', title: '前序任务', hide: true, width: 100 }
                , { field: 'STRATEGYID01', title: '源策略ID', hide: true, width: 100 }
                , { field: 'STRATEGYNAME01', title: '源策略名称', hide: true, width: 100 }

              
                , { field: 'STRATEGYID02', title: '目标策略ID', hide: true, width: 100 }
                , { field: 'STRATEGYNAME02', title: '目标策略名称', hide: true, width: 100 }

             
                , { field: 'TASKORDERDATA', title: '下达信息', hide: true, width: 100 }
            
                , { field: 'CREATEBY', title: '创建人', hide: false, width: 130 }
                , { field: 'STARTDATE', title: '开始时间', hide: false, width: 180 }
                , { field: 'ENDDATE', title: '结束时间', hide: false, width: 180 }
                , { field: 'CANCELDATE', title: '取消时间', hide: false, width: 180 }
              

                , { field: 'SOURCEAREA', title: '源区域', hide: false, width: 150, style: 'background-color: #007688; color: #fff;' }
                , { field: 'SOURCE01', title: '源位置', hide: false, width: 150, style: 'background-color: #007688; color: #fff;' }


                , { field: 'DESTINATIONAREA', title: '目标区域', hide: false, width: 150, style: 'background-color: #000088; color: #fff;' }
                , { field: 'DESTINATION01', title: '目标位置', hide: false, width: 150, style: 'background-color: #000088; color: #fff;' }

                , { field: 'TASKDATE', title: '任务日期', hide: false, width: 120 }

                , { field: 'TASKMESSAGE', title: '任务消息', hide: false, width: 200 }

                , { field: 'RELATENO', title: '关联单号', hide: false, width: 150 }

                , { field: 'EVENTID', title: '事件ID', hide: false, width: 100 }

                , { field: 'BILLID', title: '单据ID', hide: false, width: 100 }
                , { field: 'BILLID_LINENUM', title: '单据行号', hide: false, width: 100 }

             
                , { field: 'PALLETID_LINENUM', title: '托盘行号', hide: false, width: 100 }
                , { field: 'PALLETTYPE', title: '托盘类型', hide: false, width: 100 }

                , { field: 'TRUCKNO_PLAN', title: '运单计划号', hide: true, width: 100 }
                , { field: 'TRUCKNO_OPUSER', title: '操作人计划号', hide: true, width: 100 }
                , { field: 'TRUCKNO', title: '车辆编号', hide: false, width: 100 }
                , { field: 'OPUSER', title: '操作人', hide: false, width: 100 }
                , { field: 'CUSTOMCOL01', title: '属性1', hide: false, width: 100 }
                , { field: 'CUSTOMCOL02', title: '属性2', hide: false, width: 100 }
                , { field: 'CUSTOMCOL03', title: '属性3', hide: false, width: 100 }
                , { field: 'CUSTOMCOL04', title: '属性4', hide: false, width: 100 }
                , { field: 'CUSTOMCOL05', title: '属性5', hide: false, width: 100 }
                , { field: 'CUSTOMCOL06', title: '属性6', hide: false, width: 100 }
                , { field: 'CUSTOMCOL07', title: '属性7', hide: false, width: 100 }
                , { field: 'CUSTOMCOL08', title: '属性8', hide: false, width: 100 }
                , { field: 'CUSTOMCOL09', title: '属性9', hide: false, width: 100 }
                , { field: 'CUSTOMCOL10', title: '属性10', hide: false, width: 100 }
                , { fixed: 'right', title: '操作', toolbar: '#opbarTask', width: 280 }
            ]
            ],
            page: true,
            limit: 100,
            height: 'full-320',
            even: true,
            toolbar: true,
            initSort: {
                field: 'ID' //排序字段，对应 cols 设定的各字段名
                , type: 'desc' //排序方式  asc: 升序、desc: 降序、null: 默认排序
            }
        });


        //子任务数据列表
        table.render({
            elem: '#id-tablelist-taskstep',
            data: [],
            cols: [[
                { field: 'ID', title: 'ID', hide: false, width: 100 }
                , { field: 'TASKID', title: '任务ID', hide: false, width: 100 }
                , { field: 'TASKNO', title: '任务号', hide: false, width: 100 }
                , { field: 'CREATEDATE', title: '创建日期', hide: true, width: 160 }
                , { field: 'CREATEBY', title: '创建人', hide: true, width: 100 }
                , { field: 'STEPNAME', title: '步骤', hide: false, width: 200 }
                , { field: 'STEPSTATE', title: '状态', hide: false, width: 200, templet: '#taskstepstateTpl' }
                , { field: 'STEPMESSAGE', title: '消息', hide: true, width: 100 }
                , { field: 'STN_FROM', title: '站台1', hide: false, width: 100 }
                , { field: 'STN_TO', title: '站台2', hide: false, width: 100 }

                , { fixed: 'right', title: '操作', toolbar: '#opbarTaskstep', width: 100 }
            ]
            ],
            page: true,
            limit: 100,
            height: 'full-200',
            even: true,
            toolbar: true,
            initSort: {
                field: 'ID' //排序字段，对应 cols 设定的各字段名
                , type: 'asc' //排序方式  asc: 升序、desc: 降序、null: 默认排序
            }
        });


        //监听行工具事件
        table.on('tool(filter-tasktablelist)', function (obj) {
            var data = obj.data;
            switch (obj.event) {
                case 'over':

                    //if (data.TASKSTATE != '1') {
                    //    return;
                    //}

                    layer.confirm('确认结束' + data.TASKNO + '任务？', function (index) {
                        taskover(data);
                    });

                    break;

                case 'cancel':

                    //if (data.TASKSTATE != '1') {
                    //    return;
                    //}

                    layer.confirm('确认下达取消DCS执行吗？' + data.TASKNO + '任务？', function (index) {
                        taskcancel(data);
                    });

                    break;
                 case 'order':

                    if (data.TASKSTATE != '0') {
                        layer.msg('当前状态不允许操作！');
                        return;
                    }

                    layer.confirm('确认重新下达DCS执行吗？' + data.TASKNO + '任务？', function (index) {
                        taskorder(data);
                    });

                    break;
                case 'viewdetail':

                    viewdetail(data);
                    break;
            };
        });

        taskover = function (data) {
            var postData = {
                ACTION: 101,
                TASKNO: data.TASKNO,
                TASKOPACTION: 'Over'
            };

            admin.req({
                type: "get",
                url: setter.taskop,
                data: postData,
                dataType: 'json', //返回的类型
                success: function (resultdata) {
                    layer.msg(resultdata.msg);
                    layui.table.reload('id-tablelist-task'); //重载表格
                }
            });
        };

        taskcancel = function (data) {
            var postData = {
                ACTION: 101,
                TASKNO: data.TASKNO,
                TASKOPACTION: 'Cancel'
            };

            admin.req({
                type: "get",
                url: setter.taskop,
                data: postData,
                dataType: 'json', //返回的类型
                success: function (resultdata) {
                    layer.msg(resultdata.msg);
                    layui.table.reload('id-tablelist-task'); //重载表格
                }
            });
        };

         taskorder = function (data) {
            var postData = {
                ACTION: 101,
                TASKNO: data.TASKNO,
                TASKOPACTION: 'OrderDCS'
            };

            admin.req({
                type: "get",
                url: setter.taskop,
                data: postData,
                dataType: 'json', //返回的类型
                success: function (resultdata) {
                    layer.msg(resultdata.msg);
                    layui.table.reload('id-tablelist-task'); //重载表格
                }
            });
        };

        viewdetail = function (data) {
            //添加条件
            var serviceurl = setter.gettasklist + '?ACTION=1001&TASKNO=' + data.TASKNO;
            layui.table.reload('id-tablelist-taskstep', { url: serviceurl });
            //切换到指定Tab项
            element.tabChange('filter-tab-task', '2');
        };


        //监听行工具事件
        table.on('tool(filter-tasksteptablelist)', function (obj) {
            var data = obj.data;
            if (obj.event === 'return') {
                //切换到指定Tab项
                element.tabChange('filter-tab-task', '1');
            }
        });

        //监听指定开关
        form.on('switch(taskIsHistorySwitch)', function (data) {
            if (data.elem.checked) {
                data.elem.value = "1";
            }
            else {
                data.elem.value = "0";
            }
        });

        //监听提交
        form.on('submit(tasksearchfilter)', function (data) {
            //layer.msg(JSON.stringify(data.field));
            //layer.msg(data.field.TASKTCLASS);
            data.field.IsHistory = $('#task-IsHistory').val();
            //添加条件
            var serviceurl = setter.gettasklist + '?ACTION=100';
            layui.table.reload('id-tablelist-task', { url: serviceurl, where: data.field });

            //table.reload('id-tablelist-task');
            return false;
        });

        //监听提交
        form.on('submit(task-CancelOpration)', function (data) {
            //layer.msg(JSON.stringify(data.field));

            var msg = "确认对任务ID：" + data.field.TASKID + " 任务号：" + data.field.TASKNO + ",执行" + data.field.CANCELCODE + "取消？？？";
            layer.confirm(msg, { icon: 3, title: '提示' }, function (index) {

                admin.req({
                    type: "get",
                    url: setter.projtaskoprequest+"?ACTION=101",
                    data: data.field,
                    dataType: 'json', //返回的类型
                    success: function (resultdata) {
                        layer.alert(resultdata.msg);
                    },
                    error: function (resultdata) {
                        layer.alert(resultdata.msg);
                    }
                });

            });

            return false;
        });

        

    });
</script>

<!-- 工具栏模板-主表行操作按钮： -->
<script type="text/html" id="opbarTask">
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="over">结束</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="order">重新下达WCS</a>
    <!--<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="cancel">下达DCS取消执行</a>-->
    <!--<a class="layui-btn layui-btn-xs" lay-event="viewdetail">步骤</a>-->
</script>

<!-- 工具栏模板-明细行操作按钮： -->
<script type="text/html" id="opbarTaskstep">
    <a class="layui-btn layui-btn-xs" lay-event="return">返回</a>
</script>

<!-- 任务状态：-->
<script type="text/html" id="taskstateTpl">
    {{#  if(d.TASKSTATE === '-1'){ }}
    <span style="color: orange;">等待分配</span>
    {{# } else if(d.TASKSTATE === '0'){ }}
    <span style="color: skyblue;">新任务</span>
    {{# } else if(d.TASKSTATE === '1'){ }}
    <span style="color: blue;">装货完成</span>
    {{# } else if(d.TASKSTATE === '3'){ }}
    <span style="color: gold;">任务变更</span>
    {{# } else if(d.TASKSTATE === '99'){ }}
    <span style="color: green;">搬运完成</span>
    {{# } else if(d.TASKSTATE === '4'){ }}
    <span style="color: red;">任务取消</span>
    {{#  } else { }}
    {{ d.TASKSTATE }}
    {{#  } }}
</script>

<!-- 任务分类：-->
<script type="text/html" id="taskclassTpl">
    {{#  if(d.TASKTCLASS === '1'){ }}
    <span style="color: green;">入库任务</span>
    {{# } else if(d.TASKTCLASS === '2'){ }}
    <span style="color: red;">出库任务</span>
    {{# } else if(d.TASKTCLASS === '3'){ }}
    <span style="color: dodgerblue;">移动任务</span>
    {{# } else if(d.TASKTCLASS === '11'){ }}
    <span style="color: blue;">人工入库</span>
    {{# } else if(d.TASKTCLASS === '22'){ }}
    <span style="color: blue;">人工出库</span>
    {{#  } else { }}
    {{ d.TASKTCLASS }}
    {{#  } }}
</script>

<!-- 任务状态：-->
<script type="text/html" id="taskstepstateTpl">
    {{#  if(d.STEPSTATE === '0'){ }}
    <span style="color: skyblue;">新任务</span>
    {{# } else if(d.STEPSTATE === '1'){ }}
    <span style="color: blue;">已下达</span>
    {{# } else if(d.STEPSTATE === '2'){ }}
    <span style="color: green;">装货完成</span>
    {{# } else if(d.STEPSTATE === '3'){ }}
    <span style="color: skyblue;">任务结束</span>
    {{# } else if(d.STEPSTATE === '4'){ }}
    <span style="color: red;">取消</span>
    {{#  } else { }}
    {{ d.STEPSTATE }}
    {{#  } }}
</script>
